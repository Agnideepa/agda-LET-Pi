\begin{code}
module Languages.Let where

open import Data.Nat using (â„• ; suc ; zero)
open import Data.Vec using (Vec ; [] ; _âˆ·_ ; _[_]=_ ; lookup)
open import Data.Fin using (Fin; zero; suc)
open import Languages.MLPi
open import Languages.PiTyped using (ğ•“ ; _+_ ; _Ã—_ ; ğŸ™ ; val ; [] ; [_,_] ; left ; right)

-- Now we work with environments
\end{code}

%<*env-declare>
\begin{code}
data _env : âˆ€{n : â„•} â†’ (Vec ğ•“ n) â†’ Set where
  Îµ : [] env
  _+â‚‘_ : âˆ€{n : â„•}{Î“ : Vec ğ•“ n}{b : ğ•“}
         â†’ Î“ env
         â†’ (x : val b)
        ----------
         â†’ (b âˆ· Î“) env
\end{code}
%</env-declare>


\begin{code}

Vec-elem : âˆ€{n : â„•} â†’ Vec ğ•“ n â†’ Fin n â†’ ğ•“
Vec-elem (b âˆ· l) zero = b
Vec-elem (b âˆ· l) (suc n) = Vec-elem l n

_[_] : âˆ€{n : â„•} â†’ âˆ€{Î“ : Vec ğ•“ n} â†’ Î“ env â†’ (x : Fin n) â†’ val (lookup Î“ x)
(Ï +â‚‘ v) [ zero ] = v
(Ï +â‚‘ _) [ suc m ] = Ï [ m ]

{- Failed attempt at shorter impl
_[_] : âˆ€{n}{b}{x : Fin n} â†’ âˆ€{Î“ : Vec ğ•“ n} â†’ {Î“ [ x ]= b} â†’ Î“ env â†’ (x) â†’ val b
(Ï +â‚‘ v) [ zero ] = v
(Ï +â‚‘ _) [ suc m ] = Ï [ m ]
-}

-- Typing Rules and forming expressions

data _âŠ¢expâˆ¶_ : âˆ€{n : â„•} â†’ âˆ€(Î“ : Vec ğ•“ n) â†’ ğ•“ â†’ Set where
  []â‚‘ : âˆ€{n : â„•}{Î“ : Vec ğ•“ n}
        ----------
        â†’ Î“ âŠ¢expâˆ¶ ğŸ™
  leftâ‚‘ : âˆ€{n : â„•}{bâ‚ bâ‚‚ : ğ•“}{Î“ : Vec ğ•“ n}
        â†’ Î“ âŠ¢expâˆ¶ bâ‚
        ----------
        â†’ Î“ âŠ¢expâˆ¶ (bâ‚ + bâ‚‚)
  rightâ‚‘ : âˆ€{n : â„•}{bâ‚ bâ‚‚ : ğ•“}{Î“ : Vec ğ•“ n}
        â†’ Î“ âŠ¢expâˆ¶ bâ‚‚
        ----------
        â†’ Î“ âŠ¢expâˆ¶ (bâ‚ + bâ‚‚)
\end{code}

%<*debruijn>
\begin{code}
  varâ‚‘ : âˆ€{n : â„•}{Î“ : Vec ğ•“ n}
        â†’ (x : Fin n)
        ----------
        â†’ Î“ âŠ¢expâˆ¶ (lookup Î“ x)
\end{code}
%</debruijn>

\begin{code}
  â‚‘let_â‚‘in_ :  âˆ€{n : â„•}{bâ‚ bâ‚‚ : ğ•“}{Î“ : Vec ğ•“ n}
        â†’ Î“ âŠ¢expâˆ¶ bâ‚
        â†’ (bâ‚ âˆ· Î“) âŠ¢expâˆ¶ bâ‚‚
        ----------
        â†’ Î“ âŠ¢expâˆ¶ bâ‚‚
\end{code}
%<*fst-example>
\begin{code}
  fstâ‚‘ : âˆ€{n : â„•}{bâ‚ bâ‚‚ : ğ•“}{Î“ : Vec ğ•“ n}
        â†’ Î“ âŠ¢expâˆ¶ (bâ‚ Ã— bâ‚‚)
        ----------
        â†’ Î“ âŠ¢expâˆ¶ bâ‚
\end{code}
%</fst-example>
\begin{code}
  sndâ‚‘ : âˆ€{n : â„•}{bâ‚ bâ‚‚ : ğ•“}{Î“ : Vec ğ•“ n}
        â†’ Î“ âŠ¢expâˆ¶ (bâ‚ Ã— bâ‚‚)
        ----------
        â†’ Î“ âŠ¢expâˆ¶ bâ‚‚
  <_,_>â‚‘ :  âˆ€{n : â„•}{bâ‚ bâ‚‚ : ğ•“}{Î“ : Vec ğ•“ n}
        â†’ Î“ âŠ¢expâˆ¶ bâ‚
        â†’ Î“ âŠ¢expâˆ¶ bâ‚‚
        ----------
        â†’ Î“ âŠ¢expâˆ¶ (bâ‚ Ã— bâ‚‚)
\end{code}

%<*case-example>
\begin{code}
  â‚‘case_â‚‘L_â‚‘R_ : âˆ€{n : â„•}{bâ‚ bâ‚‚ bâ‚ƒ : ğ•“}{Î“ : Vec ğ•“ n}
        â†’ Î“ âŠ¢expâˆ¶ (bâ‚ + bâ‚‚)
        â†’ (bâ‚ âˆ· Î“) âŠ¢expâˆ¶ bâ‚ƒ
        â†’ (bâ‚‚ âˆ· Î“) âŠ¢expâˆ¶ bâ‚ƒ
        ----------
        â†’ Î“ âŠ¢expâˆ¶ bâ‚ƒ
\end{code}
%</case-example>

\begin{code}

-- EVALUATION
\end{code}

%<*eval-declare>
\begin{code}
evalâ‚‘ : âˆ€{n : â„•}{Î“ : Vec ğ•“ n}{b : ğ•“} â†’ Î“ env â†’ Î“ âŠ¢expâˆ¶ b â†’ val b
\end{code}
%</eval-declare>

\begin{code}
evalâ‚‘ _ []â‚‘ = []
\end{code}

%<*left>
\begin{code}
evalâ‚‘ Ï (leftâ‚‘ e) = left (evalâ‚‘ Ï e)
\end{code}
%</left>

\begin{code}
evalâ‚‘ Ï (rightâ‚‘ e) = right (evalâ‚‘ Ï e)
evalâ‚‘ Ï (varâ‚‘ x) = Ï [ x ]
\end{code}

%<*let>
\begin{code}
evalâ‚‘ Ï (â‚‘let eâ‚ â‚‘in eâ‚‚) = evalâ‚‘ (Ï +â‚‘ (evalâ‚‘ Ï eâ‚)) eâ‚‚
\end{code}
%</let>

\begin{code}
evalâ‚‘ Ï (fstâ‚‘ e) with (evalâ‚‘ Ï e)
...                 | [ vâ‚ , vâ‚‚ ] = vâ‚
evalâ‚‘ Ï (sndâ‚‘ e) with (evalâ‚‘ Ï e)
...                 | [ vâ‚ , vâ‚‚ ] = vâ‚‚
evalâ‚‘ Ï (< eâ‚ , eâ‚‚ >â‚‘) = [ (evalâ‚‘ Ï eâ‚) , (evalâ‚‘ Ï eâ‚‚) ]
evalâ‚‘ Ï (â‚‘case e â‚‘L eâ‚ â‚‘R eâ‚‚) with (evalâ‚‘ Ï e)
...                 | (left v) = evalâ‚‘ (Ï +â‚‘ v) eâ‚
...                 | (right v) = evalâ‚‘ (Ï +â‚‘ v) eâ‚‚
\end{code}

        


